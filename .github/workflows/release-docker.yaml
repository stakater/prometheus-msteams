name: Release

on:
  release:
    types: [published]


env:
  REGISTRY: ghcr.io/stakater
  GHCR_USERNAME: stakater-user
  HELM_VERSION: v3.19.0

jobs:
  test:
    name: Run tests
    uses: ./.github/workflows/_test.yaml

  build-docker:
    name: Build and Publish Docker images
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      - name: Setup Docker
        id: docker
        uses: stakater/.github/.github/actions/operator/docker@main
        env:
          CONTAINER_REGISTRY_URL: ${{ env.REGISTRY }}
          CONTAINER_REGISTRY_USERNAME: ${{ env.GHCR_USERNAME }}
          CONTAINER_REGISTRY_PASSWORD: ${{ secrets.GHCR_TOKEN }}

      - name: Cache Helm
        uses: actions/cache@v4
        with:
          path: ~/.cache/helm
          key: helm-${{ env.HELM_VERSION }}-${{ runner.os }}

      - name: Set up Helm
        uses: azure/setup-helm@v4.3.1
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Cache yq
        id: cache-yq
        uses: actions/cache@v4
        with:
          path: /usr/local/bin/yq
          key: yq-latest-${{ runner.os }}

      - name: Install yq
        if: steps.cache-yq.outputs.cache-hit != 'true'
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq

      - name: Build Docker image
        run: make docker-buildx
        env:
          DOCKER_TAG_BASE: ${{ steps.docker.outputs.IMAGE_REPOSITORY }}
          VERSION: ${{ github.event.release.tag_name }}
          COMMIT: ${{ github.sha }}
          BRANCH: ${{ github.ref_name }}

      - name: Build Docker image
        run: make docker-buildx
        env:
          DOCKER_TAG_BASE: ${{ steps.docker.outputs.IMAGE_REPOSITORY }}
          VERSION: latest
          COMMIT: ${{ github.sha }}
          BRANCH: ${{ github.ref_name }}

      - name: Set version for Helm Chart
        run: |
          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          version=${{ github.event.release.tag_name }}
          # Set appVersion to the release tag
          yq -i '.appVersion = env(version)' chart/prometheus-msteams/Chart.yaml
          # Bump chart version (increment patch version)
          current_version=$(yq '.version' chart/prometheus-msteams/Chart.yaml)
          IFS='.' read -r major minor patch <<< "$current_version"
          new_version="${major}.${minor}.$((patch + 1))"
          yq -i ".version = \"${new_version}\"" chart/prometheus-msteams/Chart.yaml

          git add chart/prometheus-msteams/Chart.yaml

          # Amend the commit with original message + dependency info
          git commit --amend -m "$original_msg$deps_info"
          git push --force-with-lease

      - name: Publish Helm Chart
        run: make helm-release
        env:
          VERSION: ${{ github.ref_name }}
          TAG: ${{ github.ref_name }}
          GIT_USER: ${{ env.GHCR_USERNAME }}
          GIT_TOKEN: ${{ secrets.CONTAINER_REGISTRY_PASSWORD }}
          HELM_REGISTRY: "${{ secrets.CONTAINER_REGISTRY_URL }}/charts"
          DOCKER_REPO_BASE: ${{ secrets.CONTAINER_REGISTRY_URL }}

      - name: Publish Public Helm Chart
        run: make helm-release
        env:
          VERSION: ${{ github.ref_name }}
          TAG: ${{ github.ref_name }}
          GIT_USER: ${{ env.GHCR_USERNAME }}
          GIT_TOKEN: ${{ secrets.CONTAINER_REGISTRY_PASSWORD }}
          HELM_REGISTRY: "${{ secrets.CONTAINER_REGISTRY_URL }}/public/charts"
          DOCKER_REPO_BASE: ${{ secrets.CONTAINER_REGISTRY_URL }}/public
