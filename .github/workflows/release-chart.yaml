name: Release - Helm Chart

on:
  release:
    types: [published]

jobs:
  chart-lint-test:
    name: Lint and Test Helm Chart
    uses: ./.github/workflows/_chart_lint.yaml

  release:
    runs-on: ubuntu-latest
    needs: chart-lint-test
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        fetch-depth: 2

    - name: Cache Helm
      uses: actions/cache@v4
      with:
        path: ~/.cache/helm
        key: helm-${{ vars.HELM_VERSION }}-${{ runner.os }}

    - name: Set up Helm
      uses: azure/setup-helm@v4.3.1
      with:
        version: ${{ vars.HELM_VERSION }}

    - name: Cache yq
      id: cache-yq
      uses: actions/cache@v4
      with:
        path: /usr/local/bin/yq
        key: yq-latest-${{ runner.os }}

    - name: Install yq
      if: steps.cache-yq.outputs.cache-hit != 'true'
      run: |
        sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
        sudo chmod +x /usr/local/bin/yq

    - name: Set version for Helm Chart
      id: set-version
      run: |
        # Set appVersion to the release tag
        yq -i ".appVersion = \"${{ github.event.release.tag_name }}\"" chart/prometheus-msteams/Chart.yaml

        # Bump chart version (increment patch version)
        current_version=$(yq '.version' chart/prometheus-msteams/Chart.yaml)
        IFS='.' read -r major minor patch <<< "$current_version"
        new_version="${major}.${minor}.$((patch + 1))"
        yq -i ".version = \"${new_version}\"" chart/prometheus-msteams/Chart.yaml
        echo "OLD_HELM_CHART_VERSION=${current_version}" >> $GITHUB_OUTPUT
        echo "NEW_HELM_CHART_VERSION=${new_version}" >> $GITHUB_OUTPUT
        echo "COMMIT_MSG=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT

    - name: Update commit
      uses: EndBug/add-and-commit@v9
      with:
        author_name: GitHub Action
        author_email: 'action@github.com'
        add: 'chart/prometheus-msteams/Chart.yaml'
        message: |
          ${{ steps.set-version.outputs.COMMIT_MSG }}

          Update Helm chart version for release ${{ github.event.release.tag_name }}:
            ${{ steps.set-version.outputs.OLD_HELM_CHART_VERSION }} -> ${{ steps.set-version.outputs.NEW_HELM_CHART_VERSION }}
        commit: '--amend'
        push: '--force-with-lease'

    - name: Publish Helm Chart
      run: make helm-release
      env:
        VERSION: ${{ github.ref_name }}
        TAG: ${{ github.ref_name }}
        GIT_USER: ${{ vars.GHCR_USERNAME }}
        GIT_TOKEN: ${{ secrets.CONTAINER_REGISTRY_PASSWORD }}
        HELM_REGISTRY: "${{ secrets.CONTAINER_REGISTRY_URL }}/charts"
        DOCKER_REPO_BASE: ${{ secrets.CONTAINER_REGISTRY_URL }}

    - name: Publish Public Helm Chart
      run: make helm-release
      env:
        VERSION: ${{ github.ref_name }}
        TAG: ${{ github.ref_name }}
        GIT_USER: ${{ vars.GHCR_USERNAME }}
        GIT_TOKEN: ${{ secrets.CONTAINER_REGISTRY_PASSWORD }}
        HELM_REGISTRY: "${{ secrets.CONTAINER_REGISTRY_URL }}/public/charts"
        DOCKER_REPO_BASE: ${{ secrets.CONTAINER_REGISTRY_URL }}/public
